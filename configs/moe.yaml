# configs/moe.yaml

# --- Model Architecture (架构参数) ---
img_size: 128
patch_size: 4
embed_dim: 128            # 隐层维度
text_dim: 768             # 文本向量维度
num_experts: 4            # 专家数量
top_k: 2                  # 激活专家数
fno_modes: 16             # FNO 模态数
swin_window_size: 8       # Window Attention 窗口大小
swin_num_heads: 4         # Attention 头数
mlp_ratio: 4.0            # MLP 膨胀比
max_num_channels: 256     # 物理通道 Embedding 字典大小 (关键修正)

# --- Loss & Optimization (损失与优化) ---
aux_loss_weight: 0.01          # 负载均衡 Loss 权重
loss_type: "mse"               # 损失函数类型
lr_embedding_recovery: 1.0e-3  # 输入输出层的大习率 (关键修正)

# --- Data Arguments (数据参数) ---
dataset_name: "fluids.incompressible.Gaussians" 
data_path: "/data1/cenjianhuan/UniPDESolver/datasets"       
max_train_samples: null   # 可设置为具体数值如 1000 用于调试
max_eval_samples: null
ar_steps: 1               # 自回归步数

# --- Training Arguments (HuggingFace Trainer 参数) ---
output_dir: "./checkpoints/moe_run_final"
overwrite_output_dir: true
do_train: true
do_eval: true

# Optimization
learning_rate: 5.0e-4     # 核心层(Experts)的学习率
weight_decay: 1.0e-4
lr_scheduler_type: "cosine"
warmup_ratio: 0.05
num_train_epochs: 50

# Batch Size & Performance
per_device_train_batch_size: 8
per_device_eval_batch_size: 8
gradient_accumulation_steps: 1
fp16: false                     # 【关键】禁用半精度 (按要求)
bf16: false                     # 【关键】禁用 bf16

# Logging & Saving
logging_steps: 50
save_steps: 500
eval_steps: 500
evaluation_strategy: "steps"
save_total_limit: 3
load_best_model_at_end: true

# System
seed: 42
dataloader_num_workers: 4
remove_unused_columns: false    # 必须为 false 以保留 text_embedding 等列